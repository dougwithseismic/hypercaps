{"version":3,"file":"main.js","sources":["../../electron/services/store.ts","../../electron/services/keyboard.ts","../../electron/features/tray.ts","../../electron/main.ts"],"sourcesContent":["import { app } from \"electron\";\r\nimport path from \"path\";\r\nimport fs from \"fs/promises\";\r\nimport { HyperKeyConfig, KeyMapping } from \"./types\";\r\n\r\ninterface AppState {\r\n  mappings: KeyMapping[];\r\n  isEnabled: boolean;\r\n  startupOnBoot: boolean;\r\n  enableOnStartup: boolean;\r\n  hyperKeyConfig: HyperKeyConfig;\r\n}\r\n\r\nexport class Store {\r\n  private static instance: Store;\r\n  private state: AppState;\r\n  private filePath: string;\r\n\r\n  private constructor() {\r\n    this.filePath = path.join(app.getPath(\"userData\"), \"state.json\");\r\n    this.state = {\r\n      mappings: [],\r\n      isEnabled: true,\r\n      startupOnBoot: false,\r\n      enableOnStartup: true,\r\n      hyperKeyConfig: {\r\n        enabled: false,\r\n        trigger: \"CapsLock\",\r\n        modifiers: [],\r\n      },\r\n    };\r\n  }\r\n\r\n  public static getInstance(): Store {\r\n    if (!Store.instance) {\r\n      Store.instance = new Store();\r\n    }\r\n    return Store.instance;\r\n  }\r\n\r\n  public async load(): Promise<void> {\r\n    try {\r\n      const data = await fs.readFile(this.filePath, \"utf-8\");\r\n      this.state = JSON.parse(data);\r\n    } catch (error) {\r\n      // If file doesn't exist or is invalid, use default state\r\n      await this.save();\r\n    }\r\n  }\r\n\r\n  private async save(): Promise<void> {\r\n    try {\r\n      await fs.writeFile(this.filePath, JSON.stringify(this.state, null, 2));\r\n    } catch (error) {\r\n      console.error(\"Failed to save state:\", error);\r\n    }\r\n  }\r\n\r\n  // Mapping methods\r\n  public async getMappings(): Promise<KeyMapping[]> {\r\n    return this.state.mappings;\r\n  }\r\n\r\n  public async addMapping(\r\n    mapping: Omit<KeyMapping, \"id\">\r\n  ): Promise<KeyMapping> {\r\n    const newMapping = {\r\n      ...mapping,\r\n      id: Date.now().toString(),\r\n    };\r\n    this.state.mappings.push(newMapping);\r\n    await this.save();\r\n    return newMapping;\r\n  }\r\n\r\n  public async updateMapping(\r\n    id: string,\r\n    updates: Partial<KeyMapping>\r\n  ): Promise<KeyMapping> {\r\n    const index = this.state.mappings.findIndex((m) => m.id === id);\r\n    if (index === -1) {\r\n      throw new Error(\"Mapping not found\");\r\n    }\r\n\r\n    const updatedMapping = {\r\n      ...this.state.mappings[index],\r\n      ...updates,\r\n    };\r\n    this.state.mappings[index] = updatedMapping;\r\n    await this.save();\r\n    return updatedMapping;\r\n  }\r\n\r\n  public async deleteMapping(id: string): Promise<void> {\r\n    this.state.mappings = this.state.mappings.filter((m) => m.id !== id);\r\n    await this.save();\r\n  }\r\n\r\n  // Service state methods\r\n  public async getIsEnabled(): Promise<boolean> {\r\n    return this.state.isEnabled;\r\n  }\r\n\r\n  public async setIsEnabled(enabled: boolean): Promise<void> {\r\n    this.state.isEnabled = enabled;\r\n    await this.save();\r\n  }\r\n\r\n  // Startup settings methods\r\n  public async getStartupOnBoot(): Promise<boolean> {\r\n    return this.state.startupOnBoot;\r\n  }\r\n\r\n  public async setStartupOnBoot(enabled: boolean): Promise<void> {\r\n    this.state.startupOnBoot = enabled;\r\n    if (enabled) {\r\n      app.setLoginItemSettings({\r\n        openAtLogin: true,\r\n        path: app.getPath(\"exe\"),\r\n      });\r\n    } else {\r\n      app.setLoginItemSettings({\r\n        openAtLogin: false,\r\n      });\r\n    }\r\n    await this.save();\r\n  }\r\n\r\n  public async getEnableOnStartup(): Promise<boolean> {\r\n    return this.state.enableOnStartup;\r\n  }\r\n\r\n  public async setEnableOnStartup(enabled: boolean): Promise<void> {\r\n    this.state.enableOnStartup = enabled;\r\n    await this.save();\r\n  }\r\n\r\n  // HyperKey config methods\r\n  public async getHyperKeyConfig(): Promise<HyperKeyConfig> {\r\n    if (!this.state.hyperKeyConfig) {\r\n      // Ensure we have a default config if none exists\r\n      this.state.hyperKeyConfig = {\r\n        enabled: false,\r\n        trigger: \"CapsLock\",\r\n        modifiers: [],\r\n      };\r\n      await this.save();\r\n    }\r\n    return this.state.hyperKeyConfig;\r\n  }\r\n\r\n  public async setHyperKeyConfig(config: HyperKeyConfig): Promise<void> {\r\n    this.state.hyperKeyConfig = config;\r\n    await this.save();\r\n  }\r\n}\r\n","import { BrowserWindow, dialog } from \"electron\";\r\nimport { spawn, ChildProcess } from \"child_process\";\r\nimport path from \"path\";\r\nimport { Store } from \"./store\";\r\nimport { HyperKeyConfig, KeyMapping } from \"./types\";\r\n\r\nexport class KeyboardService {\r\n  private mainWindow: BrowserWindow | null = null;\r\n  private keyboardProcess: ChildProcess | null = null;\r\n  private store: Store;\r\n  private startupTimeout: NodeJS.Timeout | null = null;\r\n  private isStarting: boolean = false;\r\n\r\n  constructor() {\r\n    this.store = Store.getInstance();\r\n  }\r\n\r\n  public async init(): Promise<void> {\r\n    await this.store.load();\r\n    const isEnabled = await this.store.getIsEnabled();\r\n    const hyperKeyConfig = await this.store.getHyperKeyConfig();\r\n\r\n    // Update hyperkey config to match service state\r\n    if (hyperKeyConfig.enabled !== isEnabled) {\r\n      await this.store.setHyperKeyConfig({\r\n        ...hyperKeyConfig,\r\n        enabled: isEnabled,\r\n      });\r\n    }\r\n\r\n    // Send both states to the renderer\r\n    this.mainWindow?.webContents.send(\"keyboard-service-state\", isEnabled);\r\n    this.mainWindow?.webContents.send(\"hyperkey-state\", {\r\n      ...hyperKeyConfig,\r\n      enabled: isEnabled,\r\n    });\r\n\r\n    console.log(\"[KeyboardService] isEnabled:\", isEnabled);\r\n    // Only start if service is enabled\r\n    if (isEnabled) {\r\n      await this.startListening();\r\n    }\r\n  }\r\n\r\n  public setMainWindow(window: BrowserWindow): void {\r\n    this.mainWindow = window;\r\n  }\r\n\r\n  public async startListening(): Promise<void> {\r\n    console.log(\"[KeyboardService] startListening() called\");\r\n\r\n    // If already running, just return\r\n    if (this.keyboardProcess) {\r\n      console.log(\"[KeyboardService] Process already running, returning early\");\r\n      return;\r\n    }\r\n\r\n    // If starting, wait for it to complete or fail\r\n    if (this.isStarting) {\r\n      console.log(\"[KeyboardService] Process already starting, waiting...\");\r\n      await new Promise<void>((resolve) => {\r\n        const checkInterval = setInterval(() => {\r\n          if (!this.isStarting) {\r\n            clearInterval(checkInterval);\r\n            resolve();\r\n          }\r\n        }, 100);\r\n      });\r\n      return;\r\n    }\r\n\r\n    this.isStarting = true;\r\n    console.log(\r\n      \"[KeyboardService] Setting isStarting flag and sending loading state\"\r\n    );\r\n    this.mainWindow?.webContents.send(\"keyboard-service-loading\", true);\r\n\r\n    const scriptPath =\r\n      process.env.NODE_ENV === \"development\"\r\n        ? path.resolve(process.cwd(), \"electron/scripts/keyboard-monitor.ps1\")\r\n        : path.resolve(__dirname, \"../scripts/keyboard-monitor.ps1\");\r\n\r\n    console.log(\"[KeyboardService] Using script path:\", scriptPath);\r\n    console.log(\"[KeyboardService] Current environment:\", process.env.NODE_ENV);\r\n\r\n    try {\r\n      // Kill any existing process first\r\n      if (this.keyboardProcess) {\r\n        this.keyboardProcess.kill();\r\n        this.keyboardProcess = null;\r\n      }\r\n\r\n      // Get hyperkey config - store is already loaded in init()\r\n      const hyperKeyConfig = await this.store.getHyperKeyConfig();\r\n      if (!hyperKeyConfig) {\r\n        throw new Error(\"Failed to get hyperkey config\");\r\n      }\r\n\r\n      console.log(\"[KeyboardService] Got hyperkey config:\", hyperKeyConfig);\r\n\r\n      // Convert trigger to proper case for Windows.Forms.Keys enum\r\n      const config = {\r\n        ...hyperKeyConfig,\r\n        trigger: hyperKeyConfig.trigger,\r\n        // Ensure modifiers is always an array\r\n        modifiers: Array.isArray(hyperKeyConfig.modifiers)\r\n          ? hyperKeyConfig.modifiers\r\n          : [],\r\n      };\r\n\r\n      console.log(\"[KeyboardService] Processed config:\", config);\r\n\r\n      // Create PowerShell command that sets config and runs script\r\n      const command = [\r\n        // First set the config\r\n        \"$Config = @{\",\r\n        `enabled=$${config.enabled.toString().toLowerCase()};`,\r\n        `trigger='${config.trigger}';`,\r\n        // Always create a PowerShell array, even if empty\r\n        `modifiers=@(${config.modifiers.map((m) => `'${m}'`).join(\",\") || \"@()\"});`,\r\n        `capsLockBehavior='${config.capsLockBehavior || \"BlockToggle\"}';`,\r\n        \"};\",\r\n        // Log the config for debugging\r\n        \"Write-Host 'Config:' $($Config | ConvertTo-Json -Depth 10);\",\r\n        // Then run the script\r\n        `& {`,\r\n        `  Set-Location '${path.dirname(scriptPath)}';`,\r\n        `  . '${scriptPath}'`,\r\n        `}`,\r\n      ].join(\" \");\r\n\r\n      console.log(\r\n        \"[KeyboardService] Spawning PowerShell process with config:\",\r\n        config,\r\n        \"\\nCommand:\",\r\n        command\r\n      );\r\n\r\n      this.keyboardProcess = spawn(\"powershell.exe\", [\r\n        \"-ExecutionPolicy\",\r\n        \"Bypass\",\r\n        \"-NoProfile\",\r\n        \"-NonInteractive\",\r\n        \"-Command\",\r\n        command,\r\n      ]);\r\n\r\n      console.log(\"[KeyboardService] Setting startup timeout\");\r\n      this.startupTimeout = setTimeout(() => {\r\n        if (this.isStarting) {\r\n          console.warn(\"[KeyboardService] Startup timeout reached (5s)\");\r\n          this.handleStartupFailure(\r\n            \"Keyboard monitor failed to start within timeout\"\r\n          );\r\n        }\r\n      }, 5000); // Reduced timeout to 5s\r\n\r\n      console.log(\"[KeyboardService] Creating startup promise\");\r\n      const startupPromise = new Promise<void>((resolve, reject) => {\r\n        const cleanup = () => {\r\n          if (this.keyboardProcess) {\r\n            this.keyboardProcess.stdout?.removeAllListeners();\r\n            this.keyboardProcess.stderr?.removeAllListeners();\r\n            this.keyboardProcess.removeAllListeners();\r\n          }\r\n        };\r\n\r\n        const onFirstData = (data: Buffer) => {\r\n          console.log(\r\n            \"[KeyboardService] Received first data:\",\r\n            data.toString().trim()\r\n          );\r\n          cleanup();\r\n          this.clearStartupState();\r\n          this.handleKeyboardOutput(data);\r\n          resolve();\r\n        };\r\n\r\n        const onStartupError = (error: Buffer) => {\r\n          console.error(\"[KeyboardService] Startup error:\", error.toString());\r\n          cleanup();\r\n          this.clearStartupState();\r\n          reject(new Error(error.toString()));\r\n        };\r\n\r\n        this.keyboardProcess?.stdout?.once(\"data\", onFirstData);\r\n        this.keyboardProcess?.stderr?.once(\"data\", onStartupError);\r\n\r\n        this.keyboardProcess?.once(\"close\", (code) => {\r\n          console.log(\r\n            \"[KeyboardService] Process closed during startup with code:\",\r\n            code\r\n          );\r\n          cleanup();\r\n          if (this.isStarting) {\r\n            reject(\r\n              new Error(`Process exited with code ${code} during startup`)\r\n            );\r\n          }\r\n        });\r\n      });\r\n\r\n      console.log(\"[KeyboardService] Awaiting startup promise\");\r\n      await startupPromise;\r\n\r\n      console.log(\"[KeyboardService] Setting up operation listeners\");\r\n      this.keyboardProcess.stdout?.on(\"data\", (data) => {\r\n        this.handleKeyboardOutput(data);\r\n      });\r\n\r\n      this.keyboardProcess.stderr?.on(\"data\", (data) => {\r\n        console.error(\"[KeyboardService] Runtime error:\", data.toString());\r\n      });\r\n\r\n      this.keyboardProcess.on(\"close\", (code) => {\r\n        console.log(\"[KeyboardService] Process closed with code:\", code);\r\n        this.clearStartupState();\r\n        this.keyboardProcess = null;\r\n        this.mainWindow?.webContents.send(\"keyboard-service-state\", false);\r\n      });\r\n\r\n      console.log(\"[KeyboardService] Updating store and sending success state\");\r\n      await this.store.setIsEnabled(true);\r\n      this.mainWindow?.webContents.send(\"keyboard-service-state\", true);\r\n    } catch (error) {\r\n      console.error(\"[KeyboardService] Startup error:\", error);\r\n      this.handleStartupFailure(\r\n        error instanceof Error ? error.message : \"Unknown error during startup\"\r\n      );\r\n    }\r\n  }\r\n\r\n  private clearStartupState(): void {\r\n    this.isStarting = false;\r\n    if (this.startupTimeout) {\r\n      clearTimeout(this.startupTimeout);\r\n      this.startupTimeout = null;\r\n    }\r\n    this.mainWindow?.webContents.send(\"keyboard-service-loading\", false);\r\n  }\r\n\r\n  private handleStartupFailure(message: string): void {\r\n    this.clearStartupState();\r\n    if (this.keyboardProcess) {\r\n      this.keyboardProcess.kill();\r\n      this.keyboardProcess = null;\r\n    }\r\n    dialog.showErrorBox(\r\n      \"Keyboard Monitor Error\",\r\n      `Failed to start keyboard monitor: ${message}`\r\n    );\r\n    this.mainWindow?.webContents.send(\"keyboard-service-state\", false);\r\n  }\r\n\r\n  public async stopListening(): Promise<void> {\r\n    if (this.keyboardProcess) {\r\n      this.keyboardProcess.stdout?.removeAllListeners();\r\n      this.keyboardProcess.stderr?.removeAllListeners();\r\n      this.keyboardProcess.removeAllListeners();\r\n\r\n      this.keyboardProcess.kill();\r\n      this.keyboardProcess = null;\r\n    }\r\n    await this.store.setIsEnabled(false);\r\n    this.mainWindow?.webContents.send(\"keyboard-service-state\", false);\r\n  }\r\n\r\n  public async getMappings(): Promise<KeyMapping[]> {\r\n    return this.store.getMappings();\r\n  }\r\n\r\n  public async addMapping(\r\n    mapping: Omit<KeyMapping, \"id\">\r\n  ): Promise<KeyMapping> {\r\n    return this.store.addMapping(mapping);\r\n  }\r\n\r\n  public async updateMapping(\r\n    id: string,\r\n    updates: Partial<KeyMapping>\r\n  ): Promise<KeyMapping> {\r\n    return this.store.updateMapping(id, updates);\r\n  }\r\n\r\n  public async deleteMapping(id: string): Promise<void> {\r\n    return this.store.deleteMapping(id);\r\n  }\r\n\r\n  private async executeCommand(command: string): Promise<void> {\r\n    try {\r\n      const { exec } = require(\"child_process\");\r\n      exec(command, (error: Error | null, stdout: string, stderr: string) => {\r\n        if (error) {\r\n          console.error(`[KeyboardService] Command execution error: ${error}`);\r\n          return;\r\n        }\r\n        if (stderr) {\r\n          console.error(`[KeyboardService] Command stderr: ${stderr}`);\r\n        }\r\n        if (stdout) {\r\n          console.log(`[KeyboardService] Command output: ${stdout}`);\r\n        }\r\n      });\r\n    } catch (error) {\r\n      console.error(\"[KeyboardService] Failed to execute command:\", error);\r\n    }\r\n  }\r\n\r\n  private async executeMapping(mapping: KeyMapping): Promise<void> {\r\n    try {\r\n      // Update metadata\r\n      const now = Date.now();\r\n      await this.store.updateMapping(mapping.id, {\r\n        metadata: {\r\n          ...mapping.metadata,\r\n          lastUsed: now,\r\n          useCount: (mapping.metadata?.useCount || 0) + 1,\r\n        },\r\n      });\r\n\r\n      // Execute based on action type\r\n      switch (mapping.actionType) {\r\n        case \"command\": {\r\n          const { exec } = require(\"child_process\");\r\n          const options: any = {\r\n            ...(mapping.options?.workingDirectory && {\r\n              cwd: mapping.options.workingDirectory,\r\n            }),\r\n            ...(mapping.options?.shell && { shell: mapping.options.shell }),\r\n          };\r\n\r\n          // For admin commands on Windows, prefix with runas\r\n          const cmd = mapping.options?.runAsAdmin\r\n            ? `powershell.exe Start-Process -Verb RunAs \"${mapping.action}\"`\r\n            : mapping.action;\r\n\r\n          if (mapping.options?.async) {\r\n            exec(cmd, options);\r\n          } else {\r\n            await new Promise((resolve, reject) => {\r\n              exec(\r\n                cmd,\r\n                options,\r\n                (error: Error | null, stdout: string, stderr: string) => {\r\n                  if (error) {\r\n                    console.error(\r\n                      `[KeyboardService] Command execution error:`,\r\n                      error\r\n                    );\r\n                    reject(error);\r\n                    return;\r\n                  }\r\n                  if (stderr) {\r\n                    console.error(`[KeyboardService] Command stderr:`, stderr);\r\n                  }\r\n                  if (stdout) {\r\n                    console.log(`[KeyboardService] Command output:`, stdout);\r\n                  }\r\n                  resolve(void 0);\r\n                }\r\n              );\r\n            });\r\n          }\r\n          break;\r\n        }\r\n\r\n        case \"script\": {\r\n          const { execFile } = require(\"child_process\");\r\n          const options: any = {\r\n            ...(mapping.options?.workingDirectory && {\r\n              cwd: mapping.options.workingDirectory,\r\n            }),\r\n          };\r\n\r\n          if (mapping.options?.async) {\r\n            execFile(mapping.action, [], options);\r\n          } else {\r\n            await new Promise((resolve, reject) => {\r\n              execFile(\r\n                mapping.action,\r\n                [],\r\n                options,\r\n                (error: Error | null, stdout: string, stderr: string) => {\r\n                  if (error) {\r\n                    console.error(\r\n                      `[KeyboardService] Script execution error:`,\r\n                      error\r\n                    );\r\n                    reject(error);\r\n                    return;\r\n                  }\r\n                  if (stderr) {\r\n                    console.error(`[KeyboardService] Script stderr:`, stderr);\r\n                  }\r\n                  if (stdout) {\r\n                    console.log(`[KeyboardService] Script output:`, stdout);\r\n                  }\r\n                  resolve(void 0);\r\n                }\r\n              );\r\n            });\r\n          }\r\n          break;\r\n        }\r\n\r\n        case \"shortcut\": {\r\n          // For keyboard shortcuts, we'll use @nut-tree/nut-js\r\n          const { keyboard, Key } = require(\"@nut-tree/nut-js\");\r\n\r\n          // Parse the shortcut string (e.g. \"control+shift+a\")\r\n          const keys = mapping.action.toLowerCase().split(\"+\");\r\n\r\n          // Press all modifier keys first\r\n          const modifierKeys = keys\r\n            .slice(0, -1)\r\n            .map((key) => {\r\n              switch (key) {\r\n                case \"control\":\r\n                case \"ctrl\":\r\n                  return Key.LeftControl;\r\n                case \"shift\":\r\n                  return Key.LeftShift;\r\n                case \"alt\":\r\n                  return Key.LeftAlt;\r\n                case \"command\":\r\n                case \"cmd\":\r\n                case \"win\":\r\n                  return Key.LeftWindows;\r\n                default:\r\n                  return null;\r\n              }\r\n            })\r\n            .filter((key) => key !== null);\r\n\r\n          // Press the final key\r\n          const finalKey = keys[keys.length - 1].toUpperCase();\r\n\r\n          // Press all keys together\r\n          await keyboard.pressKey(...modifierKeys, Key[finalKey]);\r\n          await keyboard.releaseKey(...modifierKeys, Key[finalKey]);\r\n          break;\r\n        }\r\n\r\n        default:\r\n          console.error(\r\n            `[KeyboardService] Unknown action type: ${(mapping as any).actionType}`\r\n          );\r\n      }\r\n    } catch (error) {\r\n      console.error(\"[KeyboardService] Failed to execute mapping:\", error);\r\n      dialog.showErrorBox(\r\n        \"Shortcut Error\",\r\n        `Failed to execute shortcut \"${mapping.name}\": ${error}`\r\n      );\r\n    }\r\n  }\r\n\r\n  private handleKeyboardOutput = (data: Buffer) => {\r\n    try {\r\n      const lines = data.toString().split(\"\\n\");\r\n      for (const line of lines) {\r\n        const trimmed = line.trim();\r\n        // Skip empty lines\r\n        if (!trimmed) continue;\r\n\r\n        // If line starts with '[DEBUG]', log it\r\n        if (trimmed.startsWith(\"[DEBUG]\")) {\r\n          console.log(trimmed);\r\n          continue;\r\n        }\r\n\r\n        // Parse JSON state updates\r\n        try {\r\n          const state = JSON.parse(trimmed);\r\n          console.log(\"[KeyboardService] Parsed state:\", state);\r\n\r\n          // Get current pressed keys\r\n          const pressedKeys = Array.isArray(state.pressedKeys)\r\n            ? state.pressedKeys\r\n            : [];\r\n\r\n          // Check mappings\r\n          this.store.getMappings().then((mappings) => {\r\n            for (const mapping of mappings) {\r\n              if (!mapping.enabled) continue;\r\n\r\n              // Check if all trigger keys are pressed\r\n              const allTriggersPressed = mapping.triggers.every((trigger) =>\r\n                pressedKeys.includes(trigger)\r\n              );\r\n\r\n              // If triggers match, execute the mapping\r\n              if (allTriggersPressed) {\r\n                console.log(\r\n                  `[KeyboardService] Executing mapping: ${mapping.name} (${mapping.id})`\r\n                );\r\n                this.executeMapping(mapping);\r\n              }\r\n            }\r\n          });\r\n\r\n          // Send keyboard event to renderer\r\n          this.mainWindow?.webContents.send(\"keyboard-event\", {\r\n            pressedKeys,\r\n            timestamp: Date.now(),\r\n          });\r\n        } catch (parseError) {\r\n          // Only log parsing errors for lines that look like JSON\r\n          if (trimmed.startsWith(\"{\") || trimmed.startsWith(\"[\")) {\r\n            console.error(\"Error parsing keyboard state:\", parseError);\r\n          }\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error handling keyboard output:\", error);\r\n    }\r\n  };\r\n\r\n  public dispose(): void {\r\n    this.stopListening();\r\n    this.mainWindow = null;\r\n  }\r\n\r\n  public async restartWithConfig(config: HyperKeyConfig): Promise<void> {\r\n    await this.store.setHyperKeyConfig(config);\r\n    await this.stopListening();\r\n    await this.startListening();\r\n  }\r\n}\r\n","import {\r\n  Tray,\r\n  Menu,\r\n  nativeImage,\r\n  BrowserWindow,\r\n  dialog,\r\n  globalShortcut,\r\n} from \"electron\";\r\nimport path from \"path\";\r\nimport { Store } from \"../services/store\";\r\nimport { KeyboardService } from \"../services/keyboard\";\r\n\r\nexport class TrayFeature {\r\n  private tray: Tray | null = null;\r\n  private mainWindow: BrowserWindow | null = null;\r\n  private keyboardService: KeyboardService | null = null;\r\n\r\n  constructor(mainWindow: BrowserWindow, keyboardService: KeyboardService) {\r\n    this.mainWindow = mainWindow;\r\n    this.keyboardService = keyboardService;\r\n  }\r\n\r\n  async initialize(): Promise<void> {\r\n    const icon = nativeImage\r\n      .createFromPath(path.join(__dirname, \"../../src/assets/tray-icon.png\"))\r\n      .resize({ width: 16, height: 16 });\r\n\r\n    this.tray = new Tray(icon);\r\n    this.tray.setToolTip(\"HyperCaps - Keyboard Remapping Tool\");\r\n\r\n    await this.setupTrayMenu();\r\n    this.registerGlobalShortcuts();\r\n    this.setupEventListeners();\r\n  }\r\n\r\n  private async setupTrayMenu(): Promise<void> {\r\n    if (!this.tray) return;\r\n\r\n    const store = Store.getInstance();\r\n    const isEnabled = await store.getIsEnabled();\r\n    const startupOnBoot = await store.getStartupOnBoot();\r\n    const enableOnStartup = await store.getEnableOnStartup();\r\n\r\n    const contextMenu = Menu.buildFromTemplate([\r\n      {\r\n        label: \"HyperCaps\",\r\n        enabled: false,\r\n        icon: nativeImage\r\n          .createFromPath(\r\n            path.join(__dirname, \"../../src/assets/tray-icon.png\")\r\n          )\r\n          .resize({ width: 16, height: 16 }),\r\n      },\r\n      { type: \"separator\" },\r\n      {\r\n        label: \"Enable HyperCaps\",\r\n        type: \"checkbox\",\r\n        checked: isEnabled,\r\n        accelerator: \"CommandOrControl+Shift+E\",\r\n        click: (menuItem) => {\r\n          if (menuItem.checked) {\r\n            this.keyboardService?.startListening();\r\n          } else {\r\n            this.keyboardService?.stopListening();\r\n          }\r\n          this.mainWindow?.webContents.send(\r\n            \"keyboard-service-state\",\r\n            menuItem.checked\r\n          );\r\n        },\r\n      },\r\n      { type: \"separator\" },\r\n      {\r\n        label: \"Start with Windows\",\r\n        type: \"checkbox\",\r\n        checked: startupOnBoot,\r\n        click: async (menuItem) => {\r\n          await store.setStartupOnBoot(menuItem.checked);\r\n        },\r\n      },\r\n      {\r\n        label: \"Enable on Startup\",\r\n        type: \"checkbox\",\r\n        checked: enableOnStartup,\r\n        click: async (menuItem) => {\r\n          await store.setEnableOnStartup(menuItem.checked);\r\n        },\r\n      },\r\n      { type: \"separator\" },\r\n      {\r\n        label: \"Open Shortcut Manager\",\r\n        accelerator: \"CommandOrControl+Shift+S\",\r\n        click: () => {\r\n          this.showWindow();\r\n        },\r\n      },\r\n      { type: \"separator\" },\r\n      {\r\n        label: \"About HyperCaps\",\r\n        click: () => {\r\n          dialog.showMessageBox({\r\n            type: \"info\",\r\n            title: \"About HyperCaps\",\r\n            message: \"HyperCaps - Advanced Keyboard Remapping Tool\",\r\n            detail: \"Version 0.0.1\\nCreated for Windows power users.\",\r\n          });\r\n        },\r\n      },\r\n      { type: \"separator\" },\r\n      {\r\n        label: \"Quit HyperCaps\",\r\n        accelerator: \"CommandOrControl+Q\",\r\n        click: () => {\r\n          this.quit();\r\n        },\r\n      },\r\n    ]);\r\n\r\n    this.tray.setContextMenu(contextMenu);\r\n  }\r\n\r\n  private registerGlobalShortcuts(): void {\r\n    const ret = globalShortcut.register(\"CommandOrControl+Shift+S\", () => {\r\n      this.showWindow();\r\n    });\r\n\r\n    if (!ret) {\r\n      console.error(\"Failed to register global shortcut\");\r\n    }\r\n  }\r\n\r\n  private setupEventListeners(): void {\r\n    if (!this.tray) return;\r\n\r\n    this.tray.on(\"double-click\", () => {\r\n      this.showWindow();\r\n    });\r\n  }\r\n\r\n  private showWindow(): void {\r\n    this.mainWindow?.show();\r\n    this.mainWindow?.focus();\r\n  }\r\n\r\n  private quit(): void {\r\n    if (this.mainWindow) {\r\n      (this.mainWindow as any).isQuitting = true;\r\n    }\r\n    require(\"electron\").app.quit();\r\n  }\r\n\r\n  dispose(): void {\r\n    if (this.tray) {\r\n      this.tray.destroy();\r\n      this.tray = null;\r\n    }\r\n  }\r\n}\r\n","import { app, BrowserWindow, ipcMain, dialog, globalShortcut } from \"electron\";\nimport path from \"path\";\nimport { KeyboardService } from \"./services/keyboard\";\nimport { Store } from \"./services/store\";\nimport { TrayFeature } from \"./features/tray\";\n\n// Immediate environment logging\nconsole.log(\"=== Environment Debug ===\");\nconsole.log(\"NODE_ENV:\", process.env.NODE_ENV);\nconsole.log(\"isDev:\", process.env.NODE_ENV === \"development\");\nconsole.log(\"======================\");\n\n// Check platform - exit if not Windows\nif (process.platform !== \"win32\") {\n  dialog.showErrorBox(\n    \"Unsupported Platform\",\n    \"HyperCaps is only supported on Windows. The application will now exit.\"\n  );\n  app.quit();\n}\n\n// Handle creating/removing shortcuts on Windows when installing/uninstalling.\nif (require(\"electron-squirrel-startup\")) {\n  app.quit();\n}\n\nlet keyboardService: KeyboardService;\nlet trayFeature: TrayFeature | null = null;\nlet mainWindow: BrowserWindow | null = null;\n\nconst createWindow = async () => {\n  console.log(\"Environment:\", process.env.NODE_ENV);\n\n  // Create the browser window.\n  mainWindow = new BrowserWindow({\n    width: 1200,\n    height: 800,\n    webPreferences: {\n      nodeIntegration: false,\n      contextIsolation: true,\n      preload: path.join(__dirname, \"../preload/preload.js\"),\n    },\n    resizable: true,\n    minimizable: true,\n    maximizable: false,\n    fullscreenable: false,\n    // Round corners on Windows 11\n    roundedCorners: true,\n    backgroundMaterial: \"acrylic\",\n    darkTheme: true,\n    backgroundColor: \"#00000000\",\n  });\n\n  // Setup IPC handlers\n  ipcMain.on(\"start-listening\", () => {\n    keyboardService?.startListening();\n  });\n\n  ipcMain.on(\"stop-listening\", () => {\n    keyboardService?.stopListening();\n  });\n\n  // Mapping handlers\n  ipcMain.handle(\"get-mappings\", () => {\n    return keyboardService?.getMappings();\n  });\n\n  ipcMain.handle(\"add-mapping\", (event, mapping) => {\n    return keyboardService?.addMapping(mapping);\n  });\n\n  ipcMain.handle(\"update-mapping\", (event, id, updates) => {\n    return keyboardService?.updateMapping(id, updates);\n  });\n\n  ipcMain.handle(\"delete-mapping\", (event, id) => {\n    return keyboardService?.deleteMapping(id);\n  });\n\n  // HyperKey config handlers\n  ipcMain.handle(\"get-hyperkey-config\", async () => {\n    const store = Store.getInstance();\n    return store.getHyperKeyConfig();\n  });\n\n  ipcMain.handle(\"set-hyperkey-config\", async (event, config) => {\n    const store = Store.getInstance();\n    await store.setHyperKeyConfig(config);\n    await keyboardService?.restartWithConfig(config);\n  });\n\n  // Load appropriate content based on environment\n  if (process.env.NODE_ENV === \"development\") {\n    mainWindow.loadURL(\"http://localhost:5173\");\n  } else {\n    // In production, load the built index.html file\n    mainWindow.loadFile(path.join(__dirname, \"../dist/index.html\"));\n  }\n\n  // Hide window instead of closing when user clicks X\n  mainWindow.on(\"close\", (event) => {\n    if (!(mainWindow as any).isQuitting) {\n      event.preventDefault();\n      mainWindow?.hide();\n      return false;\n    }\n  });\n};\n\n// Add window control handlers\nipcMain.on(\"minimize-window\", () => {\n  mainWindow?.minimize();\n});\n\nipcMain.on(\"close-window\", () => {\n  mainWindow?.hide();\n});\n\n// This method will be called when Electron has finished initialization\napp.whenReady().then(async () => {\n  const store = Store.getInstance();\n  await store.load(); // Load state before creating window\n\n  // Initialize keyboard service first\n  keyboardService = new KeyboardService();\n  await keyboardService.init(); // This will auto-start if enabled in settings\n\n  // Then create window\n  await createWindow();\n  if (mainWindow) {\n    keyboardService.setMainWindow(mainWindow);\n  }\n\n  // Initialize tray feature after window is created\n  if (mainWindow && keyboardService) {\n    trayFeature = new TrayFeature(mainWindow, keyboardService);\n    await trayFeature.initialize();\n  }\n\n  // Setup startup settings IPC handlers\n  ipcMain.handle(\"get-startup-settings\", async () => {\n    return {\n      startupOnBoot: await store.getStartupOnBoot(),\n      enableOnStartup: await store.getEnableOnStartup(),\n    };\n  });\n\n  ipcMain.handle(\"set-startup-on-boot\", async (event, enabled: boolean) => {\n    await store.setStartupOnBoot(enabled);\n  });\n\n  ipcMain.handle(\"set-enable-on-startup\", async (event, enabled: boolean) => {\n    await store.setEnableOnStartup(enabled);\n  });\n});\n\n// Add proper cleanup\napp.on(\"before-quit\", () => {\n  if (keyboardService) {\n    keyboardService.dispose();\n  }\n  if (trayFeature) {\n    trayFeature.dispose();\n  }\n  globalShortcut.unregisterAll();\n});\n\n// Quit when all windows are closed, except on macOS\napp.on(\"window-all-closed\", () => {\n  if (process.platform !== \"darwin\") {\n    app.quit();\n  }\n});\n\napp.on(\"activate\", () => {\n  // On OS X it's common to re-create a window in the app when the\n  // dock icon is clicked and there are no other windows open.\n  if (BrowserWindow.getAllWindows().length === 0) {\n    createWindow();\n  }\n});\n"],"names":["app","spawn","_a","_b","_d","_c","dialog","mainWindow","keyboardService","nativeImage","Tray","Menu","globalShortcut","BrowserWindow","ipcMain"],"mappings":"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"}